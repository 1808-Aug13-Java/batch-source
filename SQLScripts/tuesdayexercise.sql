CREATE TABLE INVOICE (
    INVOICE_ID NUMBER(5) PRIMARY KEY,
    CREATED DATE,
    CUSTOMER_ID NUMBER(5),
    AMOUNT NUMBER(7, 2)
);

CREATE TABLE CUSTOMER (
    CUSTOMER_ID NUMBER(5) PRIMARY KEY,
    FIRST_NAME VARCHAR(20),
    LAST_NAME VARCHAR(20),
    COMPANY_NAME VARCHAR(50),
    BIRTHDAY DATE
);

ALTER TABLE INVOICE
ADD CONSTRAINT FK_CUSTOMER
FOREIGN KEY (CUSTOMER_ID) REFERENCES CUSTOMER;

ALTER TABLE CUSTOMER 
MODIFY COMPANY_NAME VARCHAR(50);


INSERT INTO CUSTOMER VALUES (
    1, 'CRANDON', 'RIORDAN', 'REVATURE', DATE '1997-04-21'
);

insert into CUSTOMER values (2, 'Pandora', 'Wellum', 'Ernser', DATE '1993-07-23');
insert into CUSTOMER values (3, 'Grissel', 'Chidlow', 'Schmitt Inc', DATE '1998-01-22');
insert into CUSTOMER values (4, 'Traver', 'Croisier', 'Abernathy-Donnelly', DATE '1990-08-01');
insert into CUSTOMER values (5, 'Danni', 'Gladdis', 'Ortiz and Sons', DATE '1990-08-22');
insert into CUSTOMER values (6, 'Layla', 'Feaver', 'Kling-Marvin', DATE '1996-10-18');
insert into CUSTOMER values (7, 'Charis', 'Jaime', 'Konopelski LLC', DATE '1992-08-20');
insert into CUSTOMER values (8, 'Etienne', 'Ching', 'Jerde, Upton and Davis', DATE '1993-07-23');
insert into CUSTOMER values (9, 'Flora', 'Royse', 'Aufderhar and Sons', DATE '1992-09-09');
insert into CUSTOMER values (10, 'Hunfredo', 'Hawkin', 'Collins LLC', DATE '1991-05-11');


insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (2, DATE '2017-06-05', 8, 3618.38);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (3, DATE '2015-05-06', 10, 4910.26);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (5, DATE '2018-07-11', 2, 2051.55);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (6, DATE '2017-10-13', 1, 3564.04);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (7, DATE '2017-11-24', 2, 776.87);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (8, DATE '2018-03-10', 7, 3673.25);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (9, DATE '2018-02-10', 4, 1756.5);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (10, DATE '2018-06-16', 1, 2324.01);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (11, DATE '2018-03-01', 7, 3328.0);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (12, DATE '2017-12-06', 8, 4414.38);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (13, DATE '2017-11-08', 7, 1451.71);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (14, DATE '2018-02-15', 2, 4996.16);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (15, DATE '2018-05-09', 8, 1468.4);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (16, DATE '2018-04-17', 1, 1369.78);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (17, DATE '2017-09-24', 7, 57.1);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (18, DATE '2018-01-16', 6, 3360.39);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (19, DATE '2017-09-02', 10, 3586.08);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (20, DATE '2018-01-07', 6, 3775.65);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (21, DATE '2018-07-27', 6, 902.99);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (22, DATE '2018-02-16', 6, 4833.91);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (23, DATE '2018-02-19', 6, 1139.45);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (24, DATE '2017-10-12', 9, 1242.07);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (25, DATE '2017-08-29', 4, 431.89);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (26, DATE '2018-03-26', 2, 4018.04);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (27, DATE '2018-02-07', 1, 4313.2);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (28, DATE '2018-05-07', 3, 3797.26);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (29, DATE '2018-06-17', 4, 3642.33);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (30, DATE '2017-12-16', 8, 2797.94);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (31, DATE '2018-03-11', 1, 4299.22);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (32, DATE '2018-03-23', 10, 480.02);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (33, DATE '2018-06-03', 3, 2171.61);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (34, DATE '2018-02-19', 1, 4321.32);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (35, DATE '2018-07-07', 4, 1935.93);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (36, DATE '2018-07-14', 7, 2007.51);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (37, DATE '2017-10-05', 5, 3102.05);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (38, DATE '2017-12-02', 6, 631.92);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (39, DATE '2018-08-03', 5, 1511.76);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (40, DATE '2017-12-05', 3, 1772.98);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (41, DATE '2017-12-02', 3, 882.19);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (42, DATE '2017-10-20', 4, 4379.37);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (43, DATE '2018-02-27', 9, 2450.24);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (44, DATE '2018-07-08', 5, 1353.39);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (45, DATE '2018-02-21', 3, 3311.69);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (46, DATE '2018-07-30', 7, 478.84);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (47, DATE '2018-05-17', 10, 57.04);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (48, DATE '2017-11-05', 3, 410.72);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (49, DATE '2017-10-21', 10, 4779.65);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (50, DATE '2018-05-10', 8, 1810.57);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (51, DATE '2018-04-12', 5, 3183.7);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (52, DATE '2018-05-03', 6, 918.64);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (53, DATE '2018-07-12', 3, 3303.4);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (54, DATE '2017-11-10', 3, 3125.27);
insert into INVOICE (INVOICE_ID, CREATED, CUSTOMER_ID, AMOUNT) values (55, DATE '2018-06-14', 8, 3390.07);

UPDATE INVOICE SET CREATED = DATE '2018-08-21' WHERE INVOICE_ID = 55;
COMMIT;
-- E
SELECT * FROM INVOICE
WHERE CREATED = TRUNC((
    SELECT CURRENT_DATE FROM dual
));
-- F
SELECT CUSTOMER_ID, COUNT(*) AS NUMBER_OF_PURCHASES
FROM INVOICE
GROUP BY CUSTOMER_ID
ORDER BY CUSTOMER_ID;
-- G
SELECT CUSTOMER_ID, SUM(AMOUNT) AS TOTAL_SPENT
FROM INVOICE
GROUP BY CUSTOMER_ID
ORDER BY CUSTOMER_ID;

-- H
SELECT * FROM INVOICE
WHERE CREATED >= ADD_MONTHS(TRUNC(SYSDATE,'mm'),-1) 
   and CREATED < TRUNC(SYSDATE, 'mm')
ORDER BY CREATED DESC;

--I
SELECT * 
FROM  (SELECT * FROM INVOICE ORDER BY AMOUNT DESC) 
WHERE ROWNUM <= 3
ORDER BY AMOUNT DESC;

commit;



-------------------
-- WORKING WITH JOINS
--------------------

-- WEDNESDAY
-- A
SELECT *
FROM INVOICE I
INNER JOIN CUSTOMER C ON I.CUSTOMER_ID = C.CUSTOMER_ID;


UPDATE CUSTOMER
SET INVOICE_ID = NULL
WHERE CUSTOMER_ID = 1;
COMMIT;
-- B
-- SHOWS ALL CUSTOMERS BUT NO INVOICES THAT DONT
-- HAVE AN ASSOCIATED INVOICE
SELECT *
FROM CUSTOMER C
LEFT JOIN INVOICE I ON I.CUSTOMER_ID = C.CUSTOMER_ID;

--C
-- SHOW ALL INVOICES W/ CUSTOMER NAME
SELECT I.INVOICE_ID, i.amount, CONCAT(CONCAT(C.FIRST_NAME, ' '), C.LAST_NAME) CUSTOMER_NAME 
FROM INVOICE I
FULL JOIN CUSTOMER C ON I.CUSTOMER_ID = C.CUSTOMER_ID;


--D
-- SHOW NAME OF CUSTOMER AND THE TOTAL THE HAVE SPENT
SELECT C.FIRST_NAME, C.LAST_NAME, SUM(I.AMOUNT) AS TOTAL_AMT
FROM CUSTOMER C
INNER JOIN INVOICE I
ON C.CUSTOMER_ID = I.CUSTOMER_ID
GROUP BY C.FIRST_NAME, C.LAST_NAME
ORDER BY TOTAL_AMT;
-- E
-- RETURN MOST RECENT PURCHASE
SELECT * 
FROM (
    SELECT C.FIRST_NAME, C.LAST_NAME, MAX(I.CREATED)
    FROM CUSTOMER C
    INNER JOIN INVOICE I
    ON C.CUSTOMER_ID = I.CUSTOMER_ID
    GROUP BY C.FIRST_NAME, C.LAST_NAME
)
WHERE ROWNUM < 2;

-- F
-- SHOW PURCHASER OF EACH INVOICE, ADD SALES TAX TO SUB TOTAL

SELECT C.FIRST_NAME, C.LAST_NAME, SUM(I.AMOUNT) SUB_TOTAL, ROUND((SUM(I.AMOUNT) + (SUM(I.AMOUNT) * 0.06)), 2) AS PRICE_W_TAX
FROM INVOICE I
INNER JOIN CUSTOMER C
ON I.CUSTOMER_ID = C.CUSTOMER_ID
GROUP BY C.FIRST_NAME, C.LAST_NAME;

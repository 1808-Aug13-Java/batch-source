"use strict";
// tslint:disable
// TODO: cleanup this file, it's copied as is from Angular CLI.
Object.defineProperty(exports, "__esModule", { value: true });
const webpack_sources_1 = require("webpack-sources");
const CleanCSS = require('clean-css');
function hook(compiler, action) {
    if (compiler.hooks) {
        // Webpack 4
        compiler.hooks.compilation.tap('cleancss-webpack-plugin', (compilation) => {
            compilation.hooks.optimizeChunkAssets.tapPromise('cleancss-webpack-plugin', (chunks) => action(compilation, chunks));
        });
    }
    else {
        // Webpack 3
        compiler.plugin('compilation', (compilation) => {
            compilation.plugin('optimize-chunk-assets', (chunks, callback) => action(compilation, chunks)
                .then(() => callback())
                .catch((err) => callback(err)));
        });
    }
}
class CleanCssWebpackPlugin {
    constructor(options) {
        this._options = Object.assign({ sourceMap: false, test: (file) => file.endsWith('.css') }, options);
    }
    apply(compiler) {
        hook(compiler, (compilation, chunks) => {
            const cleancss = new CleanCSS({
                compatibility: 'ie9',
                level: 2,
                inline: false,
                returnPromise: true,
                sourceMap: this._options.sourceMap,
            });
            const files = [...compilation.additionalChunkAssets];
            chunks.forEach(chunk => {
                if (chunk.files && chunk.files.length > 0) {
                    files.push(...chunk.files);
                }
            });
            const actions = files
                .filter(file => this._options.test(file))
                .map(file => {
                const asset = compilation.assets[file];
                if (!asset) {
                    return Promise.resolve();
                }
                let content;
                let map;
                if (this._options.sourceMap && asset.sourceAndMap) {
                    const sourceAndMap = asset.sourceAndMap();
                    content = sourceAndMap.source;
                    map = sourceAndMap.map;
                }
                else {
                    content = asset.source();
                }
                if (content.length === 0) {
                    return Promise.resolve();
                }
                return Promise.resolve()
                    .then(() => map ? cleancss.minify(content, map) : cleancss.minify(content))
                    .then((output) => {
                    let hasWarnings = false;
                    if (output.warnings && output.warnings.length > 0) {
                        compilation.warnings.push(...output.warnings);
                        hasWarnings = true;
                    }
                    if (output.errors && output.errors.length > 0) {
                        output.errors
                            .forEach((error) => compilation.errors.push(new Error(error)));
                        return;
                    }
                    // generally means invalid syntax so bail
                    if (hasWarnings && output.stats.minifiedSize === 0) {
                        return;
                    }
                    let newSource;
                    if (output.sourceMap) {
                        newSource = new webpack_sources_1.SourceMapSource(output.styles, file, output.sourceMap.toString(), content, map);
                    }
                    else {
                        newSource = new webpack_sources_1.RawSource(output.styles);
                    }
                    compilation.assets[file] = newSource;
                });
            });
            return Promise.all(actions);
        });
    }
}
exports.CleanCssWebpackPlugin = CleanCssWebpackPlugin;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xlYW5jc3Mtd2VicGFjay1wbHVnaW4uanMiLCJzb3VyY2VSb290IjoiLi8iLCJzb3VyY2VzIjpbInBhY2thZ2VzL2FuZ3VsYXJfZGV2a2l0L2J1aWxkX2FuZ3VsYXIvc3JjL2FuZ3VsYXItY2xpLWZpbGVzL3BsdWdpbnMvY2xlYW5jc3Mtd2VicGFjay1wbHVnaW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLGlCQUFpQjtBQUNqQiwrREFBK0Q7O0FBVy9ELHFEQUFxRTtBQUVyRSxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7QUFXdEMsU0FBUyxJQUFJLENBQ1gsUUFBYSxFQUNiLE1BQTBFO0lBRTFFLElBQUksUUFBUSxDQUFDLEtBQUssRUFBRTtRQUNsQixZQUFZO1FBQ1osUUFBUSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLHlCQUF5QixFQUFFLENBQUMsV0FBZ0IsRUFBRSxFQUFFO1lBQzdFLFdBQVcsQ0FBQyxLQUFLLENBQUMsbUJBQW1CLENBQUMsVUFBVSxDQUM5Qyx5QkFBeUIsRUFDekIsQ0FBQyxNQUFvQixFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUMsV0FBVyxFQUFFLE1BQU0sQ0FBQyxDQUN0RCxDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7S0FDSjtTQUFNO1FBQ0wsWUFBWTtRQUNaLFFBQVEsQ0FBQyxNQUFNLENBQUMsYUFBYSxFQUFFLENBQUMsV0FBZ0IsRUFBRSxFQUFFO1lBQ2xELFdBQVcsQ0FBQyxNQUFNLENBQ2hCLHVCQUF1QixFQUN2QixDQUFDLE1BQW9CLEVBQUUsUUFBK0IsRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFBRSxNQUFNLENBQUM7aUJBQ25GLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQztpQkFDdEIsS0FBSyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FDakMsQ0FBQztR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TSxJQUFJLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTt3QkFDN0MsTUFBTSxDQUFDLE1BQU07NkJBQ1YsT0FBTyxDQUFDLENBQUMsS0FBYSxFQUFFLEVBQUUsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQ3pFLE9BQU87cUJBQ1I7b0JBRUQseUNBQXlDO29CQUN6QyxJQUFJLFdBQVcsSUFBSSxNQUFNLENBQUMsS0FBSyxDQUFDLFlBQVksS0FBSyxDQUFDLEVBQUU7d0JBQ2xELE9BQU87cUJBQ1I7b0JBRUQsSUFBSSxTQUFTLENBQUM7b0JBQ2QsSUFBSSxNQUFNLENBQUMsU0FBUyxFQUFFO3dCQUNwQixTQUFTLEdBQUcsSUFBSSxpQ0FBZSxDQUM3QixNQUFNLENBQUMsTUFBTSxFQUNiLElBQUksRUFDSixNQUFNLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxFQUMzQixPQUFPLEVBQ1AsR0FBRyxDQUNKLENBQUM7cUJBQ0g7eUJBQU07d0JBQ0wsU0FBUyxHQUFHLElBQUksMkJBQVMsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7cUJBQzFDO29CQUVELFdBQVcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsU0FBUyxDQUFDO2dCQUN2QyxDQUFDLENBQUMsQ0FBQztZQUNQLENBQUMsQ0FBQyxDQUFDO1lBRUwsT0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzlCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUNGO0FBM0ZELHNEQTJGQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRzbGludDpkaXNhYmxlXG4vLyBUT0RPOiBjbGVhbnVwIHRoaXMgZmlsZSwgaXQncyBjb3BpZWQgYXMgaXMgZnJvbSBBbmd1bGFyIENMSS5cblxuLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBJbmMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuXG5pbXBvcnQgeyBDb21waWxlciwgY29tcGlsYXRpb24gfSBmcm9tICd3ZWJwYWNrJztcbmltcG9ydCB7IFJhd1NvdXJjZSwgU291cmNlLCBTb3VyY2VNYXBTb3VyY2UgfSBmcm9tICd3ZWJwYWNrLXNvdXJjZXMnO1xuXG5jb25zdCBDbGVhbkNTUyA9IHJlcXVpcmUoJ2NsZWFuLWNzcycpO1xuXG5pbnRlcmZhY2UgQ2h1bmsge1xuICBmaWxlczogc3RyaW5nW107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ2xlYW5Dc3NXZWJwYWNrUGx1Z2luT3B0aW9ucyB7XG4gIHNvdXJjZU1hcDogYm9vbGVhbjtcbiAgdGVzdDogKGZpbGU6IHN0cmluZykgPT4gYm9vbGVhbjtcbn1cblxuZnVuY3Rpb24gaG9vayhcbiAgY29tcGlsZXI6IGFueSxcbiAgYWN0aW9uOiAoY29tcGlsYXRpb246IGFueSwgY2h1bmtzOiBBcnJheTxDaHVuaz4pID0+IFByb21pc2U8dm9pZCB8IHZvaWRbXT4sXG4pIHtcbiAgaWYgKGNvbXBpbGVyLmhvb2tzKSB7XG4gICAgLy8gV2VicGFjayA0XG4gICAgY29tcGlsZXIuaG9va3MuY29tcGlsYXRpb24udGFwKCdjbGVhbmNzcy13ZWJwYWNrLXBsdWdpbicsIChjb21waWxhdGlvbjogYW55KSA9PiB7XG4gICAgICBjb21waWxhdGlvbi5ob29rcy5vcHRpbWl6ZUNodW5rQXNzZXRzLnRhcFByb21pc2UoXG4gICAgICAgICdjbGVhbmNzcy13ZWJwYWNrLXBsdWdpbicsXG4gICAgICAgIChjaHVua3M6IEFycmF5PENodW5rPikgPT4gYWN0aW9uKGNvbXBpbGF0aW9uLCBjaHVua3MpLFxuICAgICAgKTtcbiAgICB9KTtcbiAgfSBlbHNlIHtcbiAgICAvLyBXZWJwYWNrIDNcbiAgICBjb21waWxlci5wbHVnaW4oJ2NvbXBpbGF0aW9uJywgKGNvbXBpbGF0aW9uOiBhbnkpID0+IHtcbiAgICAgIGNvbXBpbGF0aW9uLnBsdWdpbihcbiAgICAgICAgJ29wdGltaXplLWNodW5rLWFzc2V0cycsXG4gICAgICAgIChjaHVua3M6IEFycmF5PENodW5rPiwgY2FsbGJhY2s6IChlcnI/OiBFcnJvcikgPT4gdm9pZCkgPT4gYWN0aW9uKGNvbXBpbGF0aW9uLCBjaHVua3MpXG4gICAgICAgICAgLnRoZW4oKCkgPT4gY2FsbGJhY2soKSlcbiAgICAgICAgICAuY2F0Y2goKGVycikgPT4gY2FsbGJhY2soZXJyKSksXG4gICAgICApO1xuICAgIH0pO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBDbGVhbkNzc1dlYnBhY2tQbHVnaW4ge1xuICBwcml2YXRlIHJlYWRvbmx5IF9vcHRpb25zOiBDbGVhbkNzc1dlYnBhY2tQbHVnaW5PcHRpb25zO1xuXG4gIGNvbnN0cnVjdG9yKG9wdGlvbnM6IFBhcnRpYWw8Q2xlYW5Dc3NXZWJwYWNrUGx1Z2luT3B0aW9ucz4pIHtcbiAgICB0aGlzLl9vcHRpb25zID0ge1xuICAgICAgc291cmNlTWFwOiBmYWxzZSxcbiAgICAgIHRlc3Q6IChmaWxlKSA9PiBmaWxlLmVuZHNXaXRoKCcuY3NzJyksXG4gICAgICAuLi5vcHRpb25zLFxuICAgIH07XG4gIH1cblxuICBhcHBseShjb21waWxlcjogQ29tcGlsZXIpOiB2b2lkIHtcbiAgICBob29rKGNvbXBpbGVyLCAoY29tcGlsYXRpb246IGNvbXBpbGF0aW9uLkNvbXBpbGF0aW9uLCBjaHVua3M6IEFycmF5PENodW5rPikgPT4ge1xuICAgICAgY29uc3QgY2xlYW5jc3MgPSBuZXcgQ2xlYW5DU1Moe1xuICAgICAgICBjb21wYXRpYmlsaXR5OiAnaWU5JyxcbiAgICAgICAgbGV2ZWw6IDIsXG4gICAgICAgIGlubGluZTogZmFsc2UsXG4gICAgICAgIHJldHVyblByb21pc2U6IHRydWUsXG4gICAgICAgIHNvdXJjZU1hcDogdGhpcy5fb3B0aW9ucy5zb3VyY2VNYXAsXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgZmlsZXM6IHN0cmluZ1tdID0gWy4uLmNvbXBpbGF0aW9uLmFkZGl0aW9uYWxDaHVua0Fzc2V0c107XG5cbiAgICAgIGNodW5rcy5mb3JFYWNoKGNodW5rID0+IHtcbiAgICAgICAgaWYgKGNodW5rLmZpbGVzICYmIGNodW5rLmZpbGVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBmaWxlcy5wdXNoKC4uLmNodW5rLmZpbGVzKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGFjdGlvbnMgPSBmaWxlc1xuICAgICAgICAuZmlsdGVyKGZpbGUgPT4gdGhpcy5fb3B0aW9ucy50ZXN0KGZpbGUpKVxuICAgICAgICAubWFwKGZpbGUgPT4ge1xuICAgICAgICAgIGNvbnN0IGFzc2V0ID0gY29tcGlsYXRpb24uYXNzZXRzW2ZpbGVdIGFzIFNvdXJjZTtcbiAgICAgICAgICBpZiAoIWFzc2V0KSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgbGV0IGNvbnRlbnQ6IHN0cmluZztcbiAgICAgICAgICBsZXQgbWFwOiBhbnk7XG4gICAgICAgICAgaWYgKHRoaXMuX29wdGlvbnMuc291cmNlTWFwICYmIGFzc2V0LnNvdXJjZUFuZE1hcCkge1xuICAgICAgICAgICAgY29uc3Qgc291cmNlQW5kTWFwID0gYXNzZXQuc291cmNlQW5kTWFwKCk7XG4gICAgICAgICAgICBjb250ZW50ID0gc291cmNlQW5kTWFwLnNvdXJjZTtcbiAgICAgICAgICAgIG1hcCA9IHNvdXJjZUFuZE1hcC5tYXA7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnRlbnQgPSBhc3NldC5zb3VyY2UoKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAoY29udGVudC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKClcbiAgICAgICAgICAgIC50aGVuKCgpID0+IG1hcCA/IGNsZWFuY3NzLm1pbmlmeShjb250ZW50LCBtYXApIDogY2xlYW5jc3MubWluaWZ5KGNvbnRlbnQpKVxuICAgICAgICAgICAgLnRoZW4oKG91dHB1dDogYW55KSA9PiB7XG4gICAgICAgICAgICAgIGxldCBoYXNXYXJuaW5ncyA9IGZhbHNlO1xuICAgICAgICAgICAgICBpZiAob3V0cHV0Lndhcm5pbmdzICYmIG91dHB1dC53YXJuaW5ncy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgY29tcGlsYXRpb24ud2FybmluZ3MucHVzaCguLi5vdXRwdXQud2FybmluZ3MpO1xuICAgICAgICAgICAgICAgIGhhc1dhcm5pbmdzID0gdHJ1ZTtcbiAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgIGlmIChvdXRwdXQuZXJyb3JzICYmIG91dHB1dC5lcnJvcnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIG91dHB1dC5lcnJvcnNcbiAgICAgICAgICAgICAgICAgIC5mb3JFYWNoKChlcnJvcjogc3RyaW5nKSA9PiBjb21waWxhdGlvbi5lcnJvcnMucHVzaChuZXcgRXJyb3IoZXJyb3IpKSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgLy8gZ2VuZXJhbGx5IG1lYW5zIGludmFsaWQgc3ludGF4IHNvIGJhaWxcbiAgICAgICAgICAgICAgaWYgKGhhc1dhcm5pbmdzICYmIG91dHB1dC5zdGF0cy5taW5pZmllZFNpemUgPT09IDApIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICBsZXQgbmV3U291cmNlO1xuICAgICAgICAgICAgICBpZiAob3V0cHV0LnNvdXJjZU1hcCkge1xuICAgICAgICAgICAgICAgIG5ld1NvdXJjZSA9IG5ldyBTb3VyY2VNYXBTb3VyY2UoXG4gICAgICAgICAgICAgICAgICBvdXRwdXQuc3R5bGVzLFxuICAgICAgICAgICAgICAgICAgZmlsZSxcbiAgICAgICAgICAgICAgICAgIG91dHB1dC5zb3VyY2VNYXAudG9TdHJpbmcoKSxcbiAgICAgICAgICAgICAgICAgIGNvbnRlbnQsXG4gICAgICAgICAgICAgICAgICBtYXAsXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBuZXdTb3VyY2UgPSBuZXcgUmF3U291cmNlKG91dHB1dC5zdHlsZXMpO1xuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgY29tcGlsYXRpb24uYXNzZXRzW2ZpbGVdID0gbmV3U291cmNlO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICByZXR1cm4gUHJvbWlzZS5hbGwoYWN0aW9ucyk7XG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==